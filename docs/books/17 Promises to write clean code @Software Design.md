# 17 Promises to write clean code @Software Design

## Source

- 「Software Design Aug. 2010 きれいなコードを書くための17の約束」 - 前橋和弥（著）

## きれいなコードを書くべき理由

- プログラムはチームで作成することもある

- プログラムは「レビュー」する必要がある
  > プログラミングという作業は独りよがりになりがちで、プログラマのスキルもばらばらであるため、品質を確保するには第三者によるレビューが必要となる。
- プログラムは「保守」される
  > 現在のプログラミングにおいて、既存システムのソースを読まなければならない機会はすくなくない。たいていの「ドキュメント」は役に立たないため、結局ソースを読まなければならない。

- きれいなコードは、考え方の整理にも役立つ
  > ある程度の大きさのプログラムを書く際には、自分の書いたコードを何度も読み返すことになる。しかし大きなプログラムは一度に頭に入らないため、きれいなコードで局所性を保つ必要がある。

## きれいなコードを書くための約束

1. 書きやすさより読みやすさを  
ある程度以上の規模のプログラムであれば、タイピングの時間よりデバッグなど後からコードを読み返す時間の方が長い。
タイプしやすいからと意味の分からない短い変数名をつけるとかえってデバッグ時にコードを読み返す時間が長くなる。

2. 規則に従うときは、常にその理由を理解しなければならない。  
規則に従うということは必ず規則を破るべき局面が来る。このときにその規則の意図するところを理解していなければこの判断ができない。
盲目的に規則に従うのは、規則が存在しない以上に危険な行為である。

3. 名前重要  
「変数名、関数名の意味を表現する名前をつける」といわれてもなかなか難しい。data、flag、modeといった名前はたいてい悪い名前である。
関数名に適切な名前が浮かばない場合、その関数は複数の処理を行っているなど、設計が適切ではないのかもしれない。
以下にいくつかガイドラインを挙げる。
一般に、関数名なら動詞が含まれる（動詞から始まる）
英単語を省略しない
フラグの場合、どの状態がtrueか分かる名前にする

4. 命名規約  
命名において機械的に守れる規約である。Pascal型式/Camel型式や、アンダースコアの使用に関する規約は、言語によってルールはそれぞれなので、言語で統一された命名規約があるのであればそれに従う。違和感はあっても問題は無い。

5. スタイルの話  
波括弧”{}”の位置や、インデントなど、今時はIDEにスタイルを強制されることが多いので、嫌でも合わせることになる。強制されないJavascriptについては、K&Rスタイルで書く人が多いが,MicrosoftのサイトではMicrosoftスタイルで公開されている。
行の最大長やインデントの深さもよく話題にあがるが、大昔の端末(80x24)の時代ではないので80文字にこだわる必要は無いが、広い画面の人が書いたソースを、ノートパソコンで修正する場合には、ソースの右端はスクロールしないと見えないと言う状況も困りものなので何らかの歯止めは必要である。また、ソースのインデントについてはTabにしてしまうとIDEによって変わってしまうため、公開する場合にはスペースに変換しておいたほうが親切である。

6. マジックナンバーを書くな  
コードを記述するときには分かっていても、後から見ると謎の数値になるのが「マジックナンバー」。C言語だとマクロを定義し、C++などでは定数等を使用するが、なんでもかんでも置き換えれば良い訳ではなく、意味の分かる名前で置き換えることでコードをわかりやすくする必要を考慮すること。

7. コピペするな  
同じコードをコピペで複数箇所に記述してしまうと、バグがあったとき両方を修正しなければならないことでテストの手間も増え、修正漏れも発生する。
この反論として「コピペすれば、それぞれ個別に修正できる。」という意見があれば、それはそのコードがたまたま見た目が似ていただけで、本来は別々の処理だったと考えられる。
これは、あまり厳密に考える必要はなく、関数化したものをコピペするのは容易でも、いったんコピペしたものをまとめるのは困難である。

8. データもできるだけ複製するな  
本来同一であるデータを複数の箇所に置くと、更新の際にすべての箇所を更新しなければならなくなったり複雑さが増す。
また、再計算すれば取得できる値についても、一度計算した値を保持しておくより必要の都度再計算したほうがプログラムは単純になる。これは処理速度とトレードオフとなるが、最適化はあまり早い段階で行うべきではない。

9. 制御構造について  
gotoであちこちジャンプするプログラムは読みにくいものだが、Cの場合には「多重ループの脱出」「エラー処理ブロックへのジャンプ」はgotoを使わざるを得ない。またCではラベル付きbreak/continueが無いのでgotoが必要となる。
gotoを否定し、フラグを導入して処理の流れを変えるのはgoto以上にプログラムを追いにくくする。

10. スコープを狭く  
グローバル変数のスコープはプログラム全体で、ローカル変数なら関数内がスコープです。どこでその変数が変更されるかはスコープ全体を解析しなければならないため、グローバル変数の場合にはプログラム全体を解析する必要がある。
関数も同じで、どこからでも呼び出せる関数は修正の影響範囲がグローバルスコープになる。

11. 記憶域期間  
記憶域期間とは、その変数の記憶領域がどれだけの期間保存されているかを意味する。たとえば自動変数であれば、記憶域期間は宣言されたブロックを抜けるまでとなる。static変数や、ヒープ領域を使用する関数など、プログラムのどこからでも呼び出せばその変数の内容が書き換わる場合、「状態を持った関数」と呼びグローバル変数に近い性質を持ってしまう。

12. プログラムから「状態」を減らせ  
グローバル変数や状態を持つ関数は、プログラムに「状態」を持ち込む。「状態」が増えれば増えるほど、プログラムの流れも追いにくくなり、テストも困難になる。
以下に気をつけることで、プログラムから「状態」を減らすことができる。
グローバル変数や、static変数はできるだけ使わない
変数は、一度代入したらできるだけ書き換えない

13. コメント  
コメントはただ闇雲に書けば良いというわけではなく、ソースだけではわからない情報を書くべきであって、自明のコメントは明らかに不要である。
コメントを書くことについてはデメリットがかなり多く、ソース修正時にはコメントも修正しなければならなかったり、コメントは自然言語であるため、曖昧ゆえに誤解され、かえってソースを読む妨げになったり、さらにさして重要ではないコメントでエディタの画面を埋め尽くし、本当に有効なソースを読みづらくしたりする。

14. セルフドキュメンテーション.  
仕事のプログラミングにおいては、ソースコード以外に大量のドキュメントを記述するが、「同じことを複数の箇所に書いてはいけない」という大原則からすれば、ドキュメントを書くこと自体が有害となる。このためドキュメントやコメントを記載するよりも、ソースコードそのものにドキュメントの意味を持たせる方が有用である。

15. KISS(Keep It Simple and Stupid)の法則  
とにかく「短くシンプル」にソースを書くこと、テクニックを披露しても、結局できあがったプログラムがいかに読みやすいかがプログラムの良し悪しの判断基準となる。
たとえば、C言語では以下に気をつけること。
ポインタ演算をつかわない
副作用のある式はそれだけを単独で書く
引数に代入しない

16. 関数の長さ  
関数の長さは「絶対に○○行以下にすべし」といったように、機械的に定められるものではないが、ひとつの関数の長さがどの程度であるのか、と言うところは頭にいれておいて損は無い。

17. ？？？  
あれ？一つ足りない・・・
